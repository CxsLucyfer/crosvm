#!/bin/bash
# Copyright 2019 The Chromium OS Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

set -e
cd "$(dirname $0)/.."

SUPPRESS=(
    # TODO(crbug/908640): To be resolved.
    collapsible_if        # 4 errors
    comparison_chain      # 1 error
    missing_safety_doc    # 30 errors
    wrong_self_convention # 8 errors
    upper_case_acronyms   # 1 errors
    from_over_into        # 1 error
    let-and-return        # 1 error

    # False positives affecting WlVfd @ `devices/src/virtio/wl.rs`.
    # Bug: https://github.com/rust-lang/rust-clippy/issues/6312
    field_reassign_with_default

    # We don't care about these lints. Okay to remain suppressed globally.
    cast_lossless
    cognitive_complexity
    enum_variant_names
    identity_op
    len_without_is_empty
    len_zero
    match_bool
    match_wild_err_arm
    module_inception
    needless_bool
    new_without_default
    or_fun_call
    should_implement_trait
    single_char_pattern
    too_many_arguments
    trivially_copy_pass_by_ref
    type_complexity
    unreadable_literal
    useless_let_if_seq
    useless_transmute
    new-ret-no-self
    result-unit-err
)

# TODO(b/192373803): Clean up clippy error is the following crates
EXCLUDE=(
    aarch64           # 16 errors
    acpi_tables       # 4 errors
    crosvm-fuzz       # 7 errors
    devices           # 92 errors
    disk              # 36 errors
    hypervisor        # 2 errors
    integration_tests # 4 errors
    kernel_loader     # 8 errors
    kvm               # 641 errors
    kvm_sys           # 613 errors
    libcrosvm_control # 5 errors
    libvda            # 79 errors
    net_sys           # 3 errors
    qcow_utils        # 4 errors
    rutabaga_gfx      # 10 errors
    rutabaga_gfx_ffi  # 3 errors
    usb_util          # 5 errors
    vhost             # 2 errors
    virtio_sys        # 9 errors
    vm_memory         # 9 errors
    x86_64            # 56 errors

)

EXCLUDE_COMMON=(
    common/cros-fuzz  # 2 errors
    common/cros_async # 8 errors
    common/io_uring   # 8 errors
    common/p9         # 3 errors
    common/sys_util   # 2 errors
)

CLIPPY_ARGS="-- ${SUPPRESS[@]/#/-Aclippy::}  -D warnings $@"

echo "Clippy crosvm workspace"
cargo clippy \
    --workspace \
    --features all-linux \
    --all-targets \
    ${EXCLUDE[@]/#/--exclude } \
    ${CLIPPY_ARGS}

for crate in common/*; do
    if [ -d "${crate}" ] &&
        [[ ! " ${EXCLUDE_COMMON[*]} " =~ " ${crate} " ]]; then
        echo ""
        echo "Clippy ${crate}"
        (cd "${crate}" && cargo clippy --all-targets ${CLIPPY_ARGS})
    fi
done
